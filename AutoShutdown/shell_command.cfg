[gcode_shell_command safe_shutdown]
command: python3 /home/pavel/printer_data/config/scripts/safe_shutdown.py
timeout: 7200
verbose: True

[gcode_macro AUTO_POWER_OFF]
gcode:
    {% if printer.print_stats.state == "printing" or printer.print_stats.state == "paused" %}
        { action_respond_info("üîÑ –í—ã–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –ø–æ—Å–ª–µ –ø–µ—á–∞—Ç–∏") }
        UPDATE_DELAYED_GCODE ID=auto_shutdown DURATION=1
    {% else %}
        { action_respond_info("‚ö° –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ") }
        RUN_SHELL_COMMAND CMD=safe_shutdown
    {% endif %}

[delayed_gcode auto_shutdown]
gcode:
    {% if printer.print_stats.state == "printing" or printer.print_stats.state == "paused" %}
        UPDATE_DELAYED_GCODE ID=auto_shutdown DURATION=60
    {% else %}
        { action_respond_info("‚ùÑÔ∏è –ó–∞–ø—É—Å–∫–∞—é –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ") }
        RUN_SHELL_COMMAND CMD=safe_shutdown
    {% endif %}

[idle_timeout]
gcode:
    BASE_IDLE_TIMEOUT_GCODE

[gcode_macro BASE_IDLE_TIMEOUT_GCODE]
description: "Turn off hotend when idle timeout is reached"
gcode:
    SET_GCODE_VARIABLE MACRO=_SP_VARS VARIABLE=resume_ext VALUE={printer.extruder.target}
    SET_GCODE_VARIABLE MACRO=_SP_VARS VARIABLE=resume_bed VALUE={printer.heater_bed.target}

    RESPOND MSG="Idle timeout: turning off hotend"
    M104 S0  ; turn off extruder heater
